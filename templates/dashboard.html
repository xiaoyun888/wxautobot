<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>机器人管理系统</title>

    <!-- 外部资源引入 -->
    <link href="https://s4.zstatic.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://s4.zstatic.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://s4.zstatic.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">

    <!-- 样式定义 -->
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #6366f1;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #06b6d4;
            --light-gray: #f3f4f6;
            --mid-gray: #e5e7eb;
            --dark-gray: #6b7280;
            --sidebar-width: 260px;
            --sidebar-width-collapsed: 80px;
            --transition-speed: 0.3s;
        }

        /* 基础样式 */
        body {
            background-color: #f9fafb;
            color: #374151;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding-top: 60px;
            transition: padding-left var(--transition-speed);
        }

        html {
            scroll-behavior: smooth;
        }

        /* 导航栏样式 */
        .navbar {
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1030;
        }

        .navbar-brand {
            color: var(--primary-color) !important;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .navbar .btn-outline-light {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .navbar .btn-outline-light:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* 侧边栏样式 */
        .sidebar {
            position: fixed;
            top: 60px;
            left: 0;
            height: calc(100vh - 60px);
            width: var(--sidebar-width);
            background-color: white;
            box-shadow: 1px 0 3px rgba(0,0,0,0.05);
            z-index: 1020;
            transition: width var(--transition-speed);
            overflow-x: hidden;
        }

        .sidebar.collapsed {
            width: var(--sidebar-width-collapsed);
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-item {
            padding: 0;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #4b5563;
            text-decoration: none;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .sidebar-link i {
            font-size: 1.25rem;
            margin-right: 12px;
            width: 24px;
            text-align: center;
        }

        .sidebar-link:hover, .sidebar-link.active {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--primary-color);
        }

        .sidebar.collapsed .sidebar-text {
            display: none;
        }

        .sidebar.collapsed .sidebar-link {
            justify-content: center;
            padding: 12px 0;
        }

        .sidebar.collapsed .sidebar-link i {
            margin-right: 0;
            font-size: 1.5rem;
        }

        /* 内容区域样式 */
        .content {
            margin-left: var(--sidebar-width);
            transition: margin-left var(--transition-speed);
            padding: 20px;
        }

        .sidebar.collapsed ~ .content {
            margin-left: var(--sidebar-width-collapsed);
        }

        .section-anchor {
            scroll-margin-top: 80px;
        }

        /* 按钮样式 */
        .toggle-sidebar {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0 15px;
        }

        .btn {
            border-radius: 6px;
            padding: 0.375rem 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-action {
            padding: 8px 20px;
            margin: 0 5px;
        }

        .btn-start {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-start:hover {
            background-color: #059669;
            border-color: #059669;
            transform: translateY(-1px);
        }

        .btn-stop {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .btn-stop:hover {
            background-color: #dc2626;
            border-color: #dc2626;
            transform: translateY(-1px);
        }

        .btn-load {
            background-color: var(--info-color);
            border-color: var(--info-color);
        }

        .btn-load:hover {
            background-color: #0891b2;
            border-color: #0891b2;
            transform: translateY(-1px);
        }

        .btn-save {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-save:hover {
            background-color: #2563eb;
            border-color: #2563eb;
            transform: translateY(-1px);
        }

        /* 卡片样式 */
        .card {
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--mid-gray);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.07);
            transform: translateY(-2px);
        }

        .card-header {
            background-color: white;
            font-weight: 600;
            color: #111827;
            border-bottom: 1px solid var(--mid-gray);
            padding: 1rem 1.25rem;
        }

        .card-body {
            padding: 1.25rem;
        }

        /* 配置区域样式 */
        .log-container {
            height: 300px;
            overflow-y: auto;
            background:#f9fafb;
            color: #1f2937;
            border-radius:8px;
            padding:15px;
            font-family:'Courier New',monospace;
            border: 1px solid var(--mid-gray);
        }

        .config-section {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--mid-gray);
        }

        .config-section:last-child {
            border-bottom: none;
        }

        .config-section h5 {
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .list-item {
            display: flex;
            margin-bottom: 10px;
        }

        .list-item input {
            flex-grow: 1;
            margin-right: 10px;
        }

        .keyword-item textarea {
            min-height:72px;
        }

        .form-control {
            border-radius: 6px;
            border: 1px solid var(--mid-gray);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .everyday-msg-item {
            background-color: #f9fafb;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px dashed #eee;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .controls-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* 移动端样式 */
        .sidebar-toggle-mobile {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            z-index: 1040;
            border: none;
            font-size: 1.25rem;
        }

        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                width: var(--sidebar-width);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .content {
                margin-left: 0;
            }

            .sidebar-toggle-mobile {
                display: block !important;
            }

            .controls-container {
                gap: 5px;
            }

            .btn-action {
                padding: 6px 12px;
                font-size: 0.875rem;
            }
        }

        @media (min-width: 993px) {
            .sidebar-toggle-mobile {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <button class="toggle-sidebar" id="toggleSidebar">
                <i class="bi bi-list"></i>
            </button>

            <a class="navbar-brand" href="#">
                机器人管理系统
            </a>

            <div class="d-flex align-items-center ms-auto">
                <div class="controls-container me-3">
                    <button id="btnStart" class="btn btn-action btn-start"><i class="bi bi-play-fill"></i> 启动机器人</button>
                    <button id="btnStop" class="btn btn-action btn-stop"><i class="bi bi-stop-fill"></i> 关闭机器人</button>
                    <button id="btnLoad" class="btn btn-action btn-load"><i class="bi bi-arrow-down-circle"></i> 加载配置</button>
                    <button id="btnSave" class="btn btn-action btn-save"><i class="bi bi-save-fill"></i> 保存配置</button>
                </div>

                <span class="text-dark me-3 d-none d-md-inline">欢迎, {{ session.username }}</span>
                <a href="/logout" class="btn btn-sm btn-outline-light"><i class="bi bi-box-arrow-right"></i> 退出</a>
            </div>
        </div>
    </nav>

    <!-- 侧边栏 -->
    <aside class="sidebar" id="sidebar">
        <ul class="sidebar-menu">
            <li class="sidebar-item">
                <a href="#api-config" class="sidebar-link">
                    <i class="bi bi-key"></i>
                    <span class="sidebar-text">OPENAI 配置</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="#prompt-config" class="sidebar-link">
                    <i class="bi bi-file-text"></i>
                    <span class="sidebar-text">人物性格配置</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="#admin-config" class="sidebar-link">
                    <i class="bi bi-person"></i>
                    <span class="sidebar-text">管理员配置</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="#private-chat-config" class="sidebar-link">
                    <i class="bi bi-chat-dots"></i>
                    <span class="sidebar-text">私聊配置</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="#group-config" class="sidebar-link">
                    <i class="bi bi-people"></i>
                    <span class="sidebar-text">群组配置</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="#friend-config" class="sidebar-link">
                    <i class="bi bi-person-plus"></i>
                    <span class="sidebar-text">好友配置</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="#keyword-config" class="sidebar-link">
                    <i class="bi bi-tag"></i>
                    <span class="sidebar-text">关键词配置</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="#schedule-config" class="sidebar-link">
                    <i class="bi bi-clock"></i>
                    <span class="sidebar-text">定时消息</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="#auto-start-stop-config" class="sidebar-link">
                    <i class="bi bi-power"></i>
                    <span class="sidebar-text">定时启停</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="#system-log" class="sidebar-link">
                    <i class="bi bi-clipboard-data"></i>
                    <span class="sidebar-text">系统日志</span>
                </a>
            </li>
        </ul>
    </aside>

    <!-- 移动端侧边栏切换按钮 -->
    <button class="sidebar-toggle-mobile" id="mobileSidebarToggle">
        <i class="bi bi-list"></i>
    </button>

    <!-- 主内容区 -->
    <div class="content">
        <div class="container-fluid">
            <div class="row">
                <!-- 配置编辑卡片 -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-gear-fill"></i> 配置编辑</div>
                        <div class="card-body">
                            <form id="configForm">
                                <!-- API 配置 -->
                                <div class="config-section section-anchor" id="api-config">
                                    <h5>API 配置</h5>
                                    <div class="mb-3">
                                        <label for="api_sdk" class="form-label">API SDK</label>
                                        <select class="form-select" id="api_sdk" name="api_sdk">
                                            {% for sdk in config.api_sdk_list %}
                                                <option value="{{ sdk }}" {% if config.api_sdk == sdk %}selected{% endif %}>{{ sdk }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="api_key" class="form-label">API Key</label>
                                        <input type="password" class="form-control" id="api_key" name="api_key" value="{{ config.api_key_display }}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="base_url" class="form-label">Base URL</label>
                                        <input type="text" class="form-control" id="base_url" name="base_url" value="{{ config.base_url }}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="model1" class="form-label">模型1</label>
                                        <input type="text" class="form-control" id="model1" name="model1" value="{{ config.model1 }}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="model2" class="form-label">模型2</label>
                                        <input type="text" class="form-control" id="model2" name="model2" value="{{ config.model2 }}">
                                    </div>
                                </div>

                                <!-- Prompt 配置 -->
                                <div class="config-section section-anchor" id="prompt-config">
                                    <h5>Prompt 配置</h5>
                                    <div class="mb-3">
                                        <label for="prompt" class="form-label">Prompt</label>
                                        <textarea class="form-control summernote" id="prompt" name="prompt" rows="5">{{ config.prompt }}</textarea>
                                    </div>
                                </div>

                                <!-- 管理员配置 -->
                                <div class="config-section section-anchor" id="admin-config">
                                    <h5>管理员配置</h5>
                                    <div class="mb-3">
                                        <label for="admin" class="form-label">管理员名称</label>
                                        <input type="text" class="form-control" id="admin" name="admin" value="{{ config.admin }}">
                                    </div>
                                </div>

                                <!-- 私聊配置 -->
                                <div class="config-section section-anchor" id="private-chat-config">
                                    <h5>私聊配置 </h5>
                                    <div class="mb-3 form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="AllListen_switch" name="AllListen_switch" {% if config.AllListen_switch %}checked{% endif %}>
                                        <label class="form-check-label" for="AllListen_switch">监听所有私聊消息</label>
                                    </div>
                                    <div class="mb-3">
                                        <label id="listenListLabel" class="form-label">
                                            {% if config.AllListen_switch %}
                                                黑名单
                                            {% else %}
                                                监听列表（白名单）
                                            {% endif %}
                                        </label>
                                        <div id="listen_list_container">
                                            {% for item in config.listen_list %}
                                            <div class="list-item">
                                                <input type="text" class="form-control" name="listen_list" value="{{ item }}">
                                                <button type="button" class="btn btn-danger btn-remove-item"><i class="bi bi-trash"></i></button>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-sm btn-primary mt-2" id="btnAddListenItem"><i class="bi bi-plus"></i> 添加项</button>
                                    </div>
                                </div>

                                <!-- 群组配置 -->
                                <div class="config-section section-anchor" id="group-config">
                                    <h5>群组配置</h5>
                                    <div class="mb-3 form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="group_switch" name="group_switch" {% if config.group_switch %}checked{% endif %}>
                                        <label class="form-check-label" for="group_switch">启用群组回复</label>
                                    </div>
                                    <div class="mb-3 form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="group_reply_at" name="group_reply_at" {% if config.group_reply_at %}checked{% endif %}>
                                        <label class="form-check-label" for="group_reply_at">@回复</label>
                                    </div>
                                    <div class="mb-3 form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="group_welcome" name="group_welcome" {% if config.group_welcome %}checked{% endif %}>
                                        <label class="form-check-label" for="group_welcome">新人欢迎</label>
                                    </div>

                                    <!-- 新人欢迎概率 -->
                                    <div class="mb-3">
                                        <label class="form-label" for="group_welcome_random">
                                            新人欢迎概率：
                                            <span id="group_welcome_random_display">{{ (config.group_welcome_random * 100) | round(0) }}%</span>
                                        </label>
                                        <div class="d-flex align-items-center gap-2">
                                            <input type="range" min="0" max="1" step="0.01" id="group_welcome_random" name="group_welcome_random" value="{{ config.group_welcome_random }}" class="form-range" style="max-width:340px">
                                            <input type="number" min="0" max="1" step="0.01" id="group_welcome_random_number" class="form-control form-control-sm" style="max-width:120px" value="{{ config.group_welcome_random }}">
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="group_welcome_msg" class="form-label">欢迎消息</label>
                                        <textarea class="form-control summernote" id="group_welcome_msg" name="group_welcome_msg" rows="3">{{ config.group_welcome_msg }}</textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">群组列表</label>
                                        <div id="group_container">
                                            {% for item in config.group %}
                                            <div class="list-item">
                                                <input type="text" class="form-control" name="group" value="{{ item }}">
                                                <button type="button" class="btn btn-danger btn-remove-item"><i class="bi bi-trash"></i></button>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-sm btn-primary mt-2" id="btnAddGroupItem"><i class="bi bi-plus"></i> 添加群组</button>
                                    </div>
                                </div>

                                <!-- 好友配置 -->
                                <div class="config-section section-anchor" id="friend-config">
                                    <h5>好友配置</h5>
                                    <div class="mb-3 form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="new_friend_switch" name="new_friend_switch" {% if config.new_friend_switch %}checked{% endif %}>
                                        <label class="form-check-label" for="new_friend_switch">自动通过好友</label>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">好友欢迎消息</label>
                                        <div id="new_friend_msg_container">
                                            {% for item in config.new_friend_msg %}
                                            <div class="list-item">
                                                <textarea class="form-control summernote" name="new_friend_msg">{{ item }}</textarea>
                                                <button type="button" class="btn btn-danger btn-remove-item"><i class="bi bi-trash"></i></button>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-sm btn-primary mt-2" id="btnAddFriendMsgItem">
                                            <i class="bi bi-plus"></i> 添加消息
                                        </button>
                                    </div>
                                </div>

                                <!-- 关键词配置 -->
                                <div class="config-section section-anchor" id="keyword-config">
                                    <h5>关键词配置</h5>
                                    <div class="mb-3 form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="chat_keyword_switch" name="chat_keyword_switch" {% if config.chat_keyword_switch %}checked{% endif %}>
                                        <label class="form-check-label" for="chat_keyword_switch">私聊关键词开关</label>
                                    </div>
                                    <div class="mb-3 form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="group_keyword_switch" name="group_keyword_switch" {% if config.group_keyword_switch %}checked{% endif %}>
                                        <label class="form-check-label" for="group_keyword_switch">群组关键词开关</label>
                                    </div>
                                    <div class="mb-2 d-flex justify-content-between align-items-center">
                                        <div class="small text-muted">左侧输入关键词，右侧输入回复内容。</div>
                                        <button type="button" class="btn btn-sm btn-primary" id="btnAddKeyword"><i class="bi bi-plus"></i> 添加关键词</button>
                                    </div>
                                    <div id="keyword_container">
                                        {% for k,v in config.keyword_dict.items() %}
                                        <div class="keyword-item row g-2 align-items-start mb-2">
                                            <div class="col-4"><input type="text" class="form-control" name="keyword_key" value="{{ k }}"></div>
                                            <div class="col-7"><textarea class="form-control" name="keyword_value">{{ v }}</textarea></div>
                                            <div class="col-1 d-grid"><button type="button" class="btn btn-danger btn-remove-keyword"><i class="bi bi-trash"></i></button></div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- 定时消息配置 -->
                                <div class="config-section section-anchor" id="schedule-config">
                                    <h5>定时消息配置</h5>

                                    <div class="mb-3 form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="everyday_msg_switch" name="everyday_msg_switch" {% if config.everyday_msg_switch %}checked{% endif %}>
                                        <label class="form-check-label" for="everyday_msg_switch">启用定时消息</label>
                                    </div>

                                    <div class="mb-2 d-flex justify-content-between align-items-center">
                                        <div class="small text-muted">为指定好友或群组设置每天定时消息</div>
                                        <button type="button" class="btn btn-sm btn-primary" id="btnAddEverydayMsgTarget">
                                            <i class="bi bi-plus"></i> 添加定时对象
                                        </button>
                                    </div>

                                    <div id="everyday_msg_container">
                                        {% for target, task_list in config.everyday_msg_dict.items() %}
                                            {% for item in task_list %}
                                            <div class="everyday-msg-item border p-2 mb-2 rounded">
                                                <div class="d-flex mb-2">
                                                    <input type="text" class="form-control me-2" name="everyday_target" value="{{ target }}" placeholder="对象名称 (好友/群组)">
                                                    <input type="time" class="form-control me-2" name="everyday_time" value="{{ item.time }}">
                                                    <button type="button" class="btn btn-danger btn-remove-everyday"><i class="bi bi-trash"></i></button>
                                                </div>
                                                <div class="everyday-msgs">
                                                    {% for msg in item.msgs %}
                                                    <div class="list-item mb-1">
                                                        <input type="text" class="form-control" name="everyday_msg" value="{{ msg }}">
                                                        <button type="button" class="btn btn-sm btn-outline-danger btn-remove-item"><i class="bi bi-x"></i></button>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <button type="button" class="btn btn-sm btn-secondary btnAddEverydayMsg"><i class="bi bi-plus"></i> 添加消息</button>
                                            </div>
                                            {% endfor %}
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- 定时启停配置 -->
                                <div class="config-section section-anchor" id="auto-start-stop-config">
                                    <h5>定时启停配置</h5>
                                    <div class="mb-3 form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="everyday_start_stop_bot_switch" name="everyday_start_stop_bot_switch" {% if config.everyday_start_stop_bot_switch %}checked{% endif %}>
                                        <label class="form-check-label" for="everyday_start_stop_bot_switch">启用定时启停</label>
                                    </div>
                                    <div class="mb-3">
                                        <label for="everyday_start_bot_time" class="form-label">启动时间</label>
                                        <input type="time" class="form-control" id="everyday_start_bot_time" name="everyday_start_bot_time" value="{{ config.everyday_start_bot_time }}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="everyday_stop_bot_time" class="form-label">停止时间</label>
                                        <input type="time" class="form-control" id="everyday_stop_bot_time" name="everyday_stop_bot_time" value="{{ config.everyday_stop_bot_time }}">
                                    </div>
                                </div>

                                <!-- 系统日志 -->
                                <div class="config-section section-anchor" id="system-log">
                                    <h5>系统日志</h5>
                                    <div class="log-container" id="logContainer">
                                        {% for log in logs %}
                                        <div class="log-entry {{ log.color }}">[{{ log.time }}] [{{ log.level }}] {{ log.message }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 外部脚本引入 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://s4.zstatic.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://s4.zstatic.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

    <!-- 页面脚本 -->
    <script>
        // DOM 加载完成后执行
        $(document).ready(function() {
            // 初始化 summernote 编辑器
            initSummernote();

            // 初始化事件监听
            initEventListeners();

            // 初始化滑块同步
            initSliderSync();
        });

        /**
         * 初始化富文本编辑器
         */
        function initSummernote() {
            $('.summernote').summernote({
                height: 100,
                toolbar: [
                    ['style', ['bold', 'italic', 'underline', 'clear']],
                    ['font', ['strikethrough', 'superscript', 'subscript']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['insert', ['link']],
                    ['view', ['fullscreen', 'codeview']]
                ]
            });
        }

        /**
         * 初始化所有事件监听
         */
        function initEventListeners() {
            // 侧边栏切换
            $('#toggleSidebar').click(toggleSidebar);

            // 移动端侧边栏切换
            $('#mobileSidebarToggle').click(toggleMobileSidebar);

            // 侧边栏链接点击事件
            $('.sidebar-link').click(handleSidebarLinkClick);

            // 保存配置按钮
            $('#btnSave').click(saveConfig);

            // 启动机器人按钮
            $('#btnStart').click(startBot);

            // 停止机器人按钮
            $('#btnStop').click(stopBot);

            // 监听列表标题切换
            $('#AllListen_switch').change(toggleListenListLabel);

            // 添加/删除项目事件
            $('#btnAddListenItem').click(addListenItem);
            $('#btnAddGroupItem').click(addGroupItem);
            $('#btnAddFriendMsgItem').click(addFriendMsgItem);
            $('#btnAddKeyword').click(addKeywordItem);
            $('#btnAddEverydayMsgTarget').click(addEverydayMsgTarget);

            // 动态删除按钮事件
            $(document).on('click', '.btn-remove-item', removeItem);
            $(document).on('click', '.btn-remove-keyword', removeKeywordItem);
            $(document).on('click', '.btn-remove-everyday', removeEverydayItem);
            $(document).on('click', '.btnAddEverydayMsg', addEverydayMsg);

            // 窗口大小变化事件
            $(window).resize(handleWindowResize);

            // 启动日志轮询
            startLogPolling();
        }

        /**
         * 侧边栏切换
         */
        function toggleSidebar() {
            $('#sidebar').toggleClass('collapsed');
        }

        /**
         * 移动端侧边栏切换
         */
        function toggleMobileSidebar() {
            $('#sidebar').toggleClass('show');
        }

        /**
         * 侧边栏链接点击处理
         */
        function handleSidebarLinkClick(e) {
            // 在移动设备上点击导航链接后关闭侧边栏
            if ($(window).width() <= 992) {
                $('#sidebar').removeClass('show');
            }

            // 更新活动状态
            $('.sidebar-link').removeClass('active');
            $(this).addClass('active');
        }

        /**
         * 保存配置
         */
        function saveConfig(callback) {
            const configData = {
                api_sdk: $('#api_sdk').val(),
                AllListen_switch: $('#AllListen_switch').is(':checked'),
                group_switch: $('#group_switch').is(':checked'),
                group_reply_at: $('#group_reply_at').is(':checked'),
                group_welcome: $('#group_welcome').is(':checked'),
                new_friend_switch: $('#new_friend_switch').is(':checked'),
                chat_keyword_switch: $('#chat_keyword_switch').is(':checked'),
                group_keyword_switch: $('#group_keyword_switch').is(':checked'),
                api_key: $('#api_key').val(),
                base_url: $('#base_url').val(),
                model1: $('#model1').val(),
                model2: $('#model2').val(),
                admin: $('#admin').val(),
                prompt: $('#prompt').summernote('code'),
                group_welcome_msg: $('#group_welcome_msg').summernote('code'),
                listen_list: [],
                group: [],
                new_friend_msg: [],
                group_welcome_random: parseFloat($('#group_welcome_random').val()),
                keyword_dict: {},
                everyday_msg_switch: $('#everyday_msg_switch').is(':checked'),
                everyday_msg_dict: {},
                everyday_start_stop_bot_switch: $('#everyday_start_stop_bot_switch').is(':checked'),
                everyday_start_bot_time: $('#everyday_start_bot_time').val(),
                everyday_stop_bot_time: $('#everyday_stop_bot_time').val()
            };

            // 收集列表数据
            collectListData(configData);

            // 发送保存请求
            $.ajax({
                url: '/save_config',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(configData),
                success: function(res) {
                    if (res.status === 'success') {
                        if (callback) callback();
                    } else {
                        alert('配置保存失败: ' + res.message);
                    }
                },
                error: function(xhr) {
                    alert('保存配置出错: ' + xhr.responseText);
                }
            });
        }

        /**
         * 收集列表数据到配置对象
         */
        function collectListData(configData) {
            // 监听列表
            $('input[name="listen_list"]').each(function() {
                let v = $(this).val().trim();
                if (v) configData.listen_list.push(v);
            });

            // 群组列表
            $('input[name="group"]').each(function() {
                let v = $(this).val().trim();
                if (v) configData.group.push(v);
            });

            // 好友消息
            $('input[name="new_friend_msg"]').each(function() {
                let v = $(this).val().trim();
                if (v) configData.new_friend_msg.push(v);
            });

            // 关键词配置
            $('#keyword_container .keyword-item').each(function() {
                let k = $(this).find('input[name="keyword_key"]').val().trim();
                let v = $(this).find('textarea[name="keyword_value"]').val();
                if (k) configData.keyword_dict[k] = v;
            });

            // 定时消息
            const grouped = {};
            $('#everyday_msg_container .everyday-msg-item').each(function() {
                const target = $(this).find('input[name="everyday_target"]').val().trim();
                const time = $(this).find('input[name="everyday_time"]').val();
                let msgs = [];

                $(this).find('input[name="everyday_msg"]').each(function() {
                    let v = $(this).val().trim();
                    if (v) msgs.push(v);
                });

                if (!target) return;
                if (!grouped[target]) grouped[target] = [];
                grouped[target].push({ time, msgs });
            });
            configData.everyday_msg_dict = grouped;
        }

        /**
         * 启动机器人
         */
        function startBot() {
            saveConfig(() => {
                $.post('/start_bot', res => {
                    alert(res.message);
                }).fail(xhr => {
                    alert('启动机器人失败: ' + xhr.responseText);
                });
            });
        }

        /**
         * 停止机器人
         */
        function stopBot() {
            $.post('/stop_bot', res => {
                alert(res.message);
            }).fail(xhr => {
                alert('停止机器人失败: ' + xhr.responseText);
            });
        }

        /**
         * 切换监听列表标题
         */
        function toggleListenListLabel() {
            if ($(this).is(':checked')) {
                $('#listenListLabel').text('黑名单');
            } else {
                $('#listenListLabel').text('监听列表（白名单）');
            }
        }

        /**
         * 初始化滑块同步
         */
        function initSliderSync() {
            const $slider = $('#group_welcome_random');
            const $number = $('#group_welcome_random_number');
            const $disp = $('#group_welcome_random_display');

            // 从滑块同步到输入框
            $slider.on('input change', function() {
                const v = parseFloat($slider.val());
                $number.val(v.toFixed(2));
                $disp.text(Math.round(v * 100) + '%');
            });

            // 从输入框同步到滑块
            $number.on('input change', function() {
                let v = parseFloat($number.val());
                if (isNaN(v)) v = 0;
                v = Math.min(1, Math.max(0, v)); // 限制在0~1之间
                $number.val(v.toFixed(2));
                $slider.val(v);
                $disp.text(Math.round(v * 100) + '%');
            });

            // 初始同步
            $slider.trigger('change');
        }

        /**
         * 添加监听项
         */
        function addListenItem() {
            $('#listen_list_container').append(`
                <div class="list-item">
                    <input type="text" class="form-control" name="listen_list" value="">
                    <button type="button" class="btn btn-danger btn-remove-item"><i class="bi bi-trash"></i></button>
                </div>
            `);
        }

        /**
         * 添加群组项
         */
        function addGroupItem() {
            $('#group_container').append(`
                <div class="list-item">
                    <input type="text" class="form-control" name="group" value="">
                    <button type="button" class="btn btn-danger btn-remove-item"><i class="bi bi-trash"></i></button>
                </div>
            `);
        }

        /**
         * 添加好友消息项
         */
        function addFriendMsgItem() {
            const newItem = $(`
                <div class="list-item">
                    <textarea class="form-control summernote" name="new_friend_msg"></textarea>
                    <button type="button" class="btn btn-danger btn-remove-item"><i class="bi bi-trash"></i></button>
                </div>
            `);
            $('#new_friend_msg_container').append(newItem);

            // 初始化富文本编辑器
            newItem.find('.summernote').summernote({
                height: 100,
                toolbar: [
                    ['style', ['bold', 'italic', 'underline', 'clear']],
                    ['font', ['strikethrough', 'superscript', 'subscript']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['insert', ['link']],
                    ['view', ['fullscreen', 'codeview']]
                ]
            });
        }

        /**
         * 添加关键词项
         */
        function addKeywordItem() {
            $('#keyword_container').append(`
                <div class="keyword-item row g-2 mb-2">
                    <div class="col-4"><input type="text" class="form-control" name="keyword_key"></div>
                    <div class="col-7"><textarea class="form-control" name="keyword_value"></textarea></div>
                    <div class="col-1 d-grid">
                        <button type="button" class="btn btn-danger btn-remove-keyword"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            `);
        }

        /**
         * 添加定时对象
         */
        function addEverydayMsgTarget() {
            const block = $(`
                <div class="everyday-msg-item border p-2 mb-2 rounded">
                    <div class="d-flex mb-2">
                        <input type="text" class="form-control me-2" name="everyday_target" placeholder="对象名称 (好友/群组)">
                        <input type="time" class="form-control me-2" name="everyday_time" value="08:00">
                        <button type="button" class="btn btn-danger btn-remove-everyday"><i class="bi bi-trash"></i></button>
                    </div>
                    <div class="everyday-msgs"></div>
                    <button type="button" class="btn btn-sm btn-secondary btnAddEverydayMsg">
                        <i class="bi bi-plus"></i> 添加消息
                    </button>
                </div>
            `);
            $('#everyday_msg_container').append(block);
        }

        /**
         * 添加定时消息
         */
        function addEverydayMsg() {
            $(this).siblings('.everyday-msgs').append(`
                <div class="list-item mb-1">
                    <input type="text" class="form-control" name="everyday_msg" placeholder="请输入消息">
                    <button type="button" class="btn btn-sm btn-outline-danger btn-remove-item"><i class="bi bi-x"></i></button>
                </div>
            `);
        }

        /**
         * 移除列表项
         */
        function removeItem() {
            $(this).closest('.list-item').remove();
        }

        /**
         * 移除关键词项
         */
        function removeKeywordItem() {
            $(this).closest('.keyword-item').remove();
        }

        /**
         * 移除定时对象
         */
        function removeEverydayItem() {
            $(this).closest('.everyday-msg-item').remove();
        }

        /**
         * 窗口大小变化处理
         */
        function handleWindowResize() {
            if ($(window).width() > 992) {
                $('#sidebar').removeClass('show');
            }
        }

        /**
         * 启动日志轮询
         */
        function startLogPolling() {
            setInterval(() => {
                $.get('/get_logs', res => {
                    const container = $('#logContainer');
                    container.empty();

                    res.logs.forEach(log => {
                        container.append(`
                            <div class="log-entry ${log.color}">
                                [${log.time}] [${log.level}] ${log.message}
                            </div>
                        `);
                    });

                    // 滚动到底部
                    container.scrollTop(container[0].scrollHeight);
                });
            }, 3000);
        }
    </script>
</body>
</html>